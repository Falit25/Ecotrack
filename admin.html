<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - EcoTrack</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <button class="theme-toggle" onclick="toggleTheme()" style="position: absolute; top: 1rem; left: 1rem;">üåô Dark Mode</button>
        <h1>üîê EcoTrack Admin Panel</h1>
        <p>Manage users and view system statistics</p>
        <button class="btn" onclick="logout()" style="position: absolute; top: 3.5rem; left: 1rem;">Logout</button>
    </header>

    <main>
        <div id="loginSection" class="calculator-container">
            <h2>Admin Login</h2>
            <form onsubmit="adminLogin(event)">
                <div class="input-group">
                    <label for="adminPassword">Admin Password:</label>
                    <div style="position: relative;">
                        <input type="password" id="adminPassword" required>
                        <span onclick="togglePassword('adminPassword')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;">üëÅÔ∏è</span>
                    </div>
                </div>
                <button type="submit" class="btn">Login as Admin</button>
            </form>
            <div id="loginMessage" class="message" style="display: none;"></div>
        </div>

        <div id="adminPanel" style="display: none;">
            <div class="viz-container">
                <h2>üìä System Statistics</h2>
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="icon">üë•</div>
                        <h3>Total Users</h3>
                        <div class="big-number" id="totalUsers">0</div>
                    </div>
                    <div class="feature-card">
                        <div class="icon">üèÜ</div>
                        <h3>Total Points</h3>
                        <div class="big-number" id="totalPoints">0</div>
                    </div>
                    <div class="feature-card">
                        <div class="icon">üìù</div>
                        <h3>Quizzes Taken</h3>
                        <div class="big-number" id="totalQuizzes">0</div>
                    </div>
                    <div class="feature-card">
                        <div class="icon">üì∏</div>
                        <h3>Pending Submissions</h3>
                        <div class="big-number" id="pendingSubmissions">0</div>
                    </div>
                </div>
            </div>

            <div class="admin-tabs">
                <button class="tab-btn active" onclick="showTab('users')">Users Management</button>
                <button class="tab-btn" onclick="showTab('submissions')">Review Submissions</button>
            </div>

            <div id="usersTab" class="viz-container">
                <h2>üë• All Registered Users</h2>
                <div id="usersTable">Loading...</div>
            </div>

            <div id="submissionsTab" class="viz-container" style="display: none;">
                <h2>üì∏ User Submissions for Review</h2>
                <div id="submissionsTable">Loading...</div>
            </div>

            <div id="userDetails" class="viz-container" style="display: none;">
                <h2>User Details</h2>
                <div id="userInfo"></div>
                <button class="btn" onclick="closeUserDetails()">Close</button>
            </div>
        </div>
    </main>

    <script>
        async function adminLogin(event) {
            event.preventDefault();
            const password = document.getElementById('adminPassword').value;

            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const data = await response.json();
                if (response.ok) {
                    localStorage.setItem('adminToken', data.token);
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'block';
                    loadAdminData();
                } else {
                    showMessage(data.error, 'error');
                }
            } catch (error) {
                showMessage('Login failed', 'error');
            }
        }

        async function loadAdminData() {
            const token = localStorage.getItem('adminToken');
            try {
                const response = await fetch('/api/admin/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const users = await response.json();
                    displayUsers(users);
                    updateStats(users);
                    loadSubmissions();
                } else {
                    logout();
                }
            } catch (error) {
                console.error('Failed to load admin data');
            }
        }

        function displayUsers(users) {
            const container = document.getElementById('usersTable');
            
            if (users.length === 0) {
                container.innerHTML = '<p>No users registered yet.</p>';
                return;
            }

            container.innerHTML = `
                <table style="width: 100%; border-collapse: collapse; background: var(--card-bg); border-radius: 10px; overflow: hidden;">
                    <thead style="background: var(--option-bg);">
                        <tr>
                            <th style="padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color);">ID</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color);">Username</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color);">Email</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color);">Points</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color);">Level</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color);">Quizzes</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color);">Joined</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color);">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 0.8rem;">${user.id}</td>
                                <td style="padding: 0.8rem; font-weight: bold;">${user.username}</td>
                                <td style="padding: 0.8rem;">${user.email}</td>
                                <td style="padding: 0.8rem; color: #28a745; font-weight: bold;">${user.points}</td>
                                <td style="padding: 0.8rem;">${user.level}</td>
                                <td style="padding: 0.8rem;">${user.quiz_count}</td>
                                <td style="padding: 0.8rem;">${new Date(user.created_at).toLocaleDateString()}</td>
                                <td style="padding: 0.8rem;">
                                    <button class="btn" onclick="viewUser(${user.id})" style="margin-right: 0.5rem; padding: 0.3rem 0.8rem; font-size: 0.8rem;">View</button>
                                    <button class="btn" onclick="suspendUser(${user.id}, ${user.suspended || 0})" style="background: #ffc107; margin-right: 0.5rem; padding: 0.3rem 0.8rem; font-size: 0.8rem;">${user.suspended ? 'Activate' : 'Suspend'}</button>
                                    <button class="btn" onclick="deleteUser(${user.id})" style="background: #dc3545; padding: 0.3rem 0.8rem; font-size: 0.8rem;">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function updateStats(users) {
            const totalUsers = users.length;
            const totalPoints = users.reduce((sum, user) => sum + user.points, 0);
            const totalQuizzes = users.reduce((sum, user) => sum + (user.quiz_count || 0), 0);

            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('totalPoints').textContent = totalPoints.toLocaleString();
            document.getElementById('totalQuizzes').textContent = totalQuizzes;
            document.getElementById('pendingSubmissions').textContent = '0';
        }

        async function viewUser(userId) {
            const token = localStorage.getItem('adminToken');
            try {
                const response = await fetch(`/api/admin/user/${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayUserDetails(data);
                }
            } catch (error) {
                alert('Failed to load user details');
            }
        }

        function displayUserDetails(data) {
            const { user, quizzes, rewards } = data;
            
            document.getElementById('userInfo').innerHTML = `
                <div class="features-grid">
                    <div class="feature-card">
                        <h3>üë§ User Info</h3>
                        <p><strong>ID:</strong> ${user.id}</p>
                        <p><strong>Username:</strong> ${user.username}</p>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>Points:</strong> ${user.points}</p>
                        <p><strong>Level:</strong> ${user.level}</p>
                        <p><strong>Joined:</strong> ${new Date(user.created_at).toLocaleDateString()}</p>
                    </div>
                    <div class="feature-card">
                        <h3>üìä Quiz Results (${quizzes.length})</h3>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${quizzes.length > 0 ? quizzes.map(quiz => `
                                <p>Score: ${quiz.score}, Footprint: ${quiz.carbon_footprint} tons - ${new Date(quiz.completed_at).toLocaleDateString()}</p>
                            `).join('') : '<p>No quizzes taken</p>'}
                        </div>
                    </div>
                    <div class="feature-card">
                        <h3>üèÜ Recent Rewards (${rewards.length})</h3>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${rewards.length > 0 ? rewards.slice(0, 10).map(reward => `
                                <p>+${reward.points} - ${reward.description} (${new Date(reward.earned_at).toLocaleDateString()})</p>
                            `).join('') : '<p>No rewards earned</p>'}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('userDetails').style.display = 'block';
        }

        function closeUserDetails() {
            document.getElementById('userDetails').style.display = 'none';
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                return;
            }

            const token = localStorage.getItem('adminToken');
            try {
                const response = await fetch(`/api/admin/user/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    alert('User deleted successfully');
                    loadAdminData();
                } else {
                    alert('Failed to delete user');
                }
            } catch (error) {
                alert('Failed to delete user');
            }
        }

        function logout() {
            localStorage.removeItem('adminToken');
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('adminPassword').value = '';
        }

        function showMessage(text, type) {
            const message = document.getElementById('loginMessage');
            message.textContent = text;
            message.className = `message ${type}`;
            message.style.display = 'block';
            setTimeout(() => message.style.display = 'none', 3000);
        }

        function toggleTheme() {
            const body = document.body;
            const button = document.querySelector('.theme-toggle');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                button.textContent = 'üåô Dark Mode';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                button.textContent = '‚òÄÔ∏è Light Mode';
                localStorage.setItem('theme', 'dark');
            }
        }

        async function suspendUser(userId, currentStatus) {
            const action = currentStatus ? 'activate' : 'suspend';
            if (!confirm(`Are you sure you want to ${action} this user?`)) return;

            const token = localStorage.getItem('adminToken');
            try {
                const response = await fetch(`/api/admin/user/${userId}/suspend`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ suspended: !currentStatus })
                });

                if (response.ok) {
                    alert(`User ${action}d successfully`);
                    loadAdminData();
                }
            } catch (error) {
                alert(`Failed to ${action} user`);
            }
        }

        async function loadSubmissions() {
            const token = localStorage.getItem('adminToken');
            try {
                const response = await fetch('/api/admin/submissions', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const submissions = await response.json();
                    displaySubmissions(submissions);
                    updatePendingCount(submissions);
                }
            } catch (error) {
                document.getElementById('submissionsTable').innerHTML = '<p>Failed to load submissions</p>';
            }
        }

        function displaySubmissions(submissions) {
            const container = document.getElementById('submissionsTable');
            
            if (submissions.length === 0) {
                container.innerHTML = '<p>No submissions yet.</p>';
                return;
            }

            container.innerHTML = `
                <table style="width: 100%; border-collapse: collapse; background: var(--card-bg); border-radius: 10px; overflow: hidden;">
                    <thead style="background: var(--option-bg);">
                        <tr>
                            <th style="padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color);">ID</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color);">User</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color);">File</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color);">Description</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color);">Status</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color);">Submitted</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color);">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${submissions.map(sub => `
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 0.8rem;">${sub.id}</td>
                                <td style="padding: 0.8rem; font-weight: bold;">${sub.username || 'Unknown'}</td>
                                <td style="padding: 0.8rem;"><a href="/uploads/${sub.filename}" target="_blank">${sub.filename}</a></td>
                                <td style="padding: 0.8rem;">${sub.description || 'No description'}</td>
                                <td style="padding: 0.8rem;"><span class="status-${sub.status}">${sub.status.toUpperCase()}</span></td>
                                <td style="padding: 0.8rem;">${new Date(sub.submitted_at).toLocaleDateString()}</td>
                                <td style="padding: 0.8rem;">
                                    ${sub.status === 'pending' ? `
                                        <button class="btn" onclick="approveSubmission(${sub.id})" style="background: #28a745; margin-right: 0.5rem; padding: 0.3rem 0.8rem; font-size: 0.8rem;">Approve</button>
                                        <button class="btn" onclick="rejectSubmission(${sub.id})" style="background: #dc3545; padding: 0.3rem 0.8rem; font-size: 0.8rem;">Reject</button>
                                    ` : `<span>Reviewed</span>`}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function updatePendingCount(submissions) {
            const pendingCount = submissions.filter(sub => sub.status === 'pending').length;
            document.getElementById('pendingSubmissions').textContent = pendingCount;
        }

        async function approveSubmission(submissionId) {
            const points = prompt('Enter points to award (default: 5):', '5');
            if (!points) return;

            const token = localStorage.getItem('adminToken');
            try {
                const response = await fetch(`/api/admin/submission/${submissionId}/approve`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ points: parseInt(points) })
                });

                if (response.ok) {
                    alert('Submission approved!');
                    loadSubmissions();
                    loadAdminData();
                }
            } catch (error) {
                alert('Failed to approve submission');
            }
        }

        async function rejectSubmission(submissionId) {
            if (!confirm('Are you sure you want to reject this submission?')) return;

            const token = localStorage.getItem('adminToken');
            try {
                const response = await fetch(`/api/admin/submission/${submissionId}/reject`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    alert('Submission rejected');
                    loadSubmissions();
                }
            } catch (error) {
                alert('Failed to reject submission');
            }
        }

        function showTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('[id$="Tab"]').forEach(t => t.style.display = 'none');
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').style.display = 'block';
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling;
            if (input.type === 'password') {
                input.type = 'text';
                icon.textContent = 'üôà';
            } else {
                input.type = 'password';
                icon.textContent = 'üëÅÔ∏è';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            const button = document.querySelector('.theme-toggle');
            
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                button.textContent = '‚òÄÔ∏è Light Mode';
            }

            const adminToken = localStorage.getItem('adminToken');
            if (adminToken) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                loadAdminData();
            }
        });
    </script>

    <style>
        .message {
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
            text-align: center;
        }
        .message.error {
            background: #fee;
            color: #c33;
            border: 1px solid #fcc;
        }
        .big-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }
        table {
            color: var(--text-color);
        }
        .admin-tabs {
            display: flex;
            margin-bottom: 2rem;
        }
        .tab-btn {
            flex: 1;
            padding: 1rem;
            border: none;
            background: var(--option-bg);
            color: var(--text-color);
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        .tab-btn.active {
            border-bottom-color: #667eea;
            background: var(--card-bg);
        }
        .status-pending { color: #ffc107; font-weight: bold; }
        .status-approved { color: #28a745; font-weight: bold; }
        .status-rejected { color: #dc3545; font-weight: bold; }
    </style>
</body>
</html>
